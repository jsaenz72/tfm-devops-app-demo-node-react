name: Fase 2 - Contenerización y Supply Chain Security

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_BACKEND: jsaenz72/app-backend
  IMAGE_FRONTEND: jsaenz72/app-frontend
  IMAGE_TAG: v1.0.0

jobs:
  build-scan-sign:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write   # necesario para Cosign (OIDC)

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    # ---------------------------
    # Login DockerHub
    # ---------------------------
    - name: Login en DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ---------------------------
    # Build Backend
    # ---------------------------
    - name: Build imagen Backend
      run: |
        docker build \
          -t $IMAGE_BACKEND:$IMAGE_TAG \
          ./backend

    # ---------------------------
    # Build Frontend
    # ---------------------------
    - name: Build imagen Frontend
      run: |
        docker build \
          -t $IMAGE_FRONTEND:$IMAGE_TAG \
          ./frontend

    # ---------------------------
    # Trivy - Escaneo Backend
    # ---------------------------
    - name: Escaneo Trivy Backend
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ env.IMAGE_BACKEND }}:${{ env.IMAGE_TAG }}
        format: table
        severity: CRITICAL,HIGH
        exit-code: 0

    # ---------------------------
    # Trivy - Escaneo Frontend
    # ---------------------------
    - name: Escaneo Trivy Frontend
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ env.IMAGE_FRONTEND }}:${{ env.IMAGE_TAG }}
        format: table
        severity: CRITICAL,HIGH
        exit-code: 0

    # ---------------------------
    # Generación SBOM Backend
    # ---------------------------
    - name: Generar SBOM Backend (CycloneDX)
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ env.IMAGE_BACKEND }}:${{ env.IMAGE_TAG }}
        format: cyclonedx
        output: sbom-backend.json

    # ---------------------------
    # Generación SBOM Frontend
    # ---------------------------
    - name: Generar SBOM Frontend (CycloneDX)
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ env.IMAGE_FRONTEND }}:${{ env.IMAGE_TAG }}
        format: cyclonedx
        output: sbom-frontend.json

    # ---------------------------
    # Publicar imágenes
    # ---------------------------
    - name: Push imágenes a DockerHub
      run: |
        docker push $IMAGE_BACKEND:$IMAGE_TAG
        docker push $IMAGE_FRONTEND:$IMAGE_TAG

    # ---------------------------
    # Instalación Cosign
    # ---------------------------
    - name: Instalar Cosign
      uses: sigstore/cosign-installer@v3.5.0

    # ---------------------------
    # Firma de imágenes
    # ---------------------------
    - name: Firmar imagen Backend con Cosign
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: |
        cosign sign $IMAGE_BACKEND:$IMAGE_TAG

    - name: Firmar imagen Frontend con Cosign
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: |
        cosign sign $IMAGE_FRONTEND:$IMAGE_TAG

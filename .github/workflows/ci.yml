name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      security-events: write

    steps:
      # ============================
      # CHECKOUT
      # ============================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================
      # NODE SETUP
      # ============================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ============================
      # BACKEND TESTS
      # ============================
      - name: Install backend dependencies
        working-directory: app-demo-node-react/backend
        run: npm ci

      - name: Run backend tests
        working-directory: app-demo-node-react/backend
        run: npm test -- --passWithNoTests

      # ============================
      # FRONTEND TESTS
      # ============================
      - name: Install frontend dependencies
        working-directory: app-demo-node-react/frontend
        run: npm ci

      - name: Build frontend
        working-directory: app-demo-node-react/frontend
        run: npm run build

      - name: Run frontend tests
        working-directory: app-demo-node-react/frontend
        run: npm test -- --passWithNoTests
        continue-on-error: true

      # ============================
      # DOCKER SETUP
      # ============================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ============================
      # BUILD BACKEND
      # ============================
      - name: Build and push Backend
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: app-demo-node-react/backend
          file: app-demo-node-react/backend/Dockerfile.prod
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================
      # BUILD FRONTEND
      # ============================
      - name: Build and push Frontend
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: app-demo-node-react/frontend
          file: app-demo-node-react/frontend/Dockerfile.prod
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          build-args: |
            API_URL=http://backend:3000
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================
      # INSTALL KUSTOMIZE
      # ============================
      - name: Install Kustomize
        run: |
          curl -s https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
          sudo mv kustomize /usr/local/bin/

      # ============================
      # UPDATE MANIFESTS WITH DIGEST
      # ============================
      - name: Update Kubernetes image digests
        run: |
          cd k8s/base/frontend
          kustomize edit set image \
          ghcr.io/jsaenz72/tfm-devops-app-demo-node-react/frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}@${{ steps.build-frontend.outputs.digest }}

          cd ../backend
          kustomize edit set image \
          ghcr.io/jsaenz72/tfm-devops-app-demo-node-react/backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}@${{ steps.build-backend.outputs.digest }}

      # ============================
      # COMMIT & PUSH (GitOps)
      # ============================
      - name: Commit and push manifest changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add k8s/
          git commit -m "Update image digest to ${{ github.sha }} [skip ci]" || echo "No changes"
          git push

      # ============================
      # SECURITY SCAN
      # ============================
      - name: Run Trivy scan (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}@${{ steps.build-backend.outputs.digest }}

      - name: Run Trivy scan (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}@${{ steps.build-frontend.outputs.digest }}

      # ============================
      # INSTALL COSIGN
      # ============================
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      # ============================
      # SIGN IMAGES
      # ============================
      - name: Sign Backend Image
        run: |
          cosign sign --yes \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}@${{ steps.build-backend.outputs.digest }}

      - name: Sign Frontend Image
        run: |
          cosign sign --yes \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}@${{ steps.build-frontend.outputs.digest }}
